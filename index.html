<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…Ø®Ø§ÙˆÙŠØ± ÙÙŠÙˆØ¯ â€” Ù†Ø³Ø®Ø© Ø¹Ù…Ù„ Ù…Ø¹ Ù…Ø¯ÙŠØ± ÙˆØ¬Ø±Ø³</title>
<style>
  :root{
    --card: rgba(3,8,16,0.75);
    --muted:#9aa7b8;
    --accent:#16a34a;
    --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02);
    --bg-grad: linear-gradient(180deg, rgba(2,6,23,0.85) 0%, rgba(2,6,23,0.85) 60%);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:
      var(--bg-grad),
      url('background.png') repeat;
    background-size: cover;
    color:#e6eef6;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
    animation: moveBg 30s linear infinite;
    transition: background-color .25s ease;
    direction: rtl;
  }
  @keyframes moveBg { from { background-position: 0 0; } to { background-position: 100% 0; } }

  .app{width:100%;max-width:1200px}
  header{display:flex;gap:12px;align-items:center;margin-bottom:18px}
  .title{font-size:22px;font-weight:800}
  .subtitle{color:var(--muted);font-size:13px}

  .layout{display:grid;grid-template-columns:380px 1fr;gap:18px}
  .panel{background:var(--card);backdrop-filter: blur(6px);border-radius:14px;padding:16px;box-shadow:0 8px 30px rgba(2,6,23,0.7)}

  .input, .select, .btn{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;margin-bottom:8px}
  .row{display:flex;gap:8px;margin-bottom:10px}
  .small{padding:8px;font-size:13px}
  .teams{display:flex;gap:8px;margin-bottom:12px}
  .team-card{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);text-align:center;position:relative}
  .team-score{font-size:20px;font-weight:900;margin-top:6px}
  .players-list{font-size:13px;color:var(--muted);margin-top:8px;text-align:center}

  .questions{max-height:260px;overflow:auto;margin-top:8px}
  .question-item{padding:10px;border-radius:10px;margin-bottom:8px;background:var(--glass-2);cursor:pointer;transition:transform .12s, background .12s}
  .question-item:hover{transform:translateY(-3px);background:rgba(255,255,255,0.035)}

  .board{display:flex;flex-direction:column;gap:12px}
  .board-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .big-question{font-size:22px;font-weight:800}
  .answers{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .answer{padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);min-height:68px;display:flex;align-items:center;justify-content:space-between;gap:12px;transition:all .18s;cursor:pointer}
  .answer.revealed{background:linear-gradient(90deg, rgba(22,163,74,0.12), rgba(22,163,74,0.06));border:1px solid rgba(22,163,74,0.14);transform:scale(1.02)}
  .answer .txt{font-size:16px}
  .answer .pts{font-weight:900}

  .controls-footer{display:flex;gap:8px}
  .btn-action{background:linear-gradient(90deg,#0ea5a3,#06b6d4);border:none;color:#042024;padding:10px 14px;border-radius:10px}
  .btn-red{background:linear-gradient(90deg,#ef4444,#f97316);border:none;color:white;padding:10px 14px;border-radius:10px}
  .hint{font-size:13px;color:var(--muted);margin-top:6px}

  #confetti { position:fixed; left:0;top:0;right:0;bottom:0; pointer-events:none; z-index:999; }
  .hidden{display:none !important}

  /* welcome overlay */
  #welcomeOverlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:1000; background: rgba(0,0,0,0.55); padding:20px; }
  .welcome-card { width:100%; max-width:820px; border-radius:18px; padding:26px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow: 0 20px 60px rgba(0,0,0,0.6); text-align:center; color: #eaf6f1; }
  .welcome-title{ font-size:48px; font-weight:900; margin:8px 0 6px 0; letter-spacing:1px; }
  .welcome-sub{ color:var(--muted); margin-bottom:18px; font-size:15px }
  .welcome-row{ display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap }
  .welcome-input{ padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:inherit; min-width:240px }
  .team-join-btn{ padding:12px 18px; border-radius:12px; border:none; cursor:pointer; font-weight:700 }
  .btn-A{ background:linear-gradient(90deg,#ef4444,#f97316); color:white; }
  .btn-B{ background:linear-gradient(90deg,#0ea5a3,#06b6d4); color:#042024; }
  .btn-mgr{ background:linear-gradient(90deg,#8257e5,#5b21b6); color:white; }

  .players-inline{ display:flex; gap:8px; justify-content:center; margin-top:8px; flex-wrap:wrap }
  .player-pill{ background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:999px; font-size:13px; color:var(--muted) }

  /* bell */
  #bellContainer { display:flex; align-items:center; justify-content:center; gap:12px; margin:12px 0; }
  #bellBtn { padding:12px 20px; border-radius:999px; border:none; font-weight:800; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.5); }
  #bellBtn.player { background:linear-gradient(90deg,#f59e0b,#f97316); color:#042024; }
  #bellBtn.disabled { opacity:0.45; cursor:not-allowed; }

  /* manager buzz queue */
  .buzz-queue { margin-top:12px; background:rgba(255,255,255,0.02); padding:8px; border-radius:10px; font-size:13px; color:var(--muted); max-height:140px; overflow:auto; }

  @media (max-width:920px){
    .layout{grid-template-columns:1fr;}.board{order:2}.panel{padding:12px}
    .answers{grid-template-columns:1fr}
    .welcome-title{font-size:36px}
  }
</style>
</head>
<body>

<style>
#welcomeScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  flex-direction: column;
  z-index: 9999;
}
#welcomeScreen input, #welcomeScreen select, #welcomeScreen button {
  margin: 5px;
  padding: 10px;
}
</style>

<div id="welcomeScreen">
  <h1>Ù…Ø®Ø§ÙˆÙŠØ± ÙÙŠÙˆØ¯</h1>
  <input type="text" id="playerNameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ">
  <select id="roleSelect">
    <option value="playerA">Ù„Ø§Ø¹Ø¨ - ÙØ±ÙŠÙ‚ A</option>
    <option value="playerB">Ù„Ø§Ø¹Ø¨ - ÙØ±ÙŠÙ‚ B</option>
    <option value="manager">Ù…Ø¯ÙŠØ± Ø§Ù„Ù„Ø¹Ø¨Ø©</option>
  </select>
  <button onclick="startGame()">Ø§Ø¨Ø¯Ø£</button>
</div>

<script>
var playerTeam = "";
var playerName = "";
var isManager = false;

function startGame(){
  playerName = document.getElementById('playerNameInput').value || "Ù„Ø§Ø¹Ø¨";
  var role = document.getElementById('roleSelect').value;

  if(role === "manager"){
    isManager = true;
    listenForBuzz();
  } else {
    isManager = false;
    playerTeam = (role === "playerA") ? "A" : "B";
    // Show buzz button for players
    var buzzBtn = document.createElement("button");
    buzzBtn.innerHTML = "ğŸ”” Ø§Ø¶ØºØ· Ø§Ù„Ø¬Ø±Ø³";
    buzzBtn.style.fontSize = "24px";
    buzzBtn.onclick = function(){ sendBuzz(playerTeam, playerName); };
    document.body.appendChild(buzzBtn);
  }

  document.getElementById('welcomeScreen').style.display = 'none';
}
</script>

  <canvas id="confetti"></canvas>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
  <div id="welcomeOverlay" role="dialog" aria-modal="true">
    <div class="welcome-card" role="document">
      <div style="display:flex;align-items:center;justify-content:center;flex-direction:column">
        <div class="welcome-title">Ù…Ø®Ø§ÙˆÙŠØ± ÙÙŠÙˆØ¯</div>
        <div class="welcome-sub">Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø«Ù… Ø§Ø®ØªØ± Ø¯ÙˆØ±Ùƒ: Ù…Ø¯ÙŠØ± Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£Ùˆ Ù„Ø§Ø¹Ø¨ (A Ø£Ùˆ B). Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù‡ ÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª. Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ù‡ Ø²Ø± Ø§Ù„Ø¬Ø±Ø³ ÙÙ‚Ø·.</div>

        <div class="welcome-row">
          <input id="playerNameInput" class="welcome-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." maxlength="24" />
        </div>

        <div class="welcome-row" style="margin-top:10px">
          <button id="beManager" class="team-join-btn btn-mgr">Ø£ÙƒÙˆÙ† Ù…Ø¯ÙŠØ± Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
          <button id="joinA" class="team-join-btn btn-A">Ø§Ù†Ø¶Ù… Ù„Ù„ÙØ±ÙŠÙ‚ A</button>
          <button id="joinB" class="team-join-btn btn-B">Ø§Ù†Ø¶Ù… Ù„Ù„ÙØ±ÙŠÙ‚ B</button>
        </div>

        <div style="margin-top:10px;color:var(--muted);font-size:13px">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© ØªØ¹Ù…Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ â€” Ø¥Ù† Ø£Ø±Ø¯Øª ØªØ²Ø§Ù…Ù† Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø£Ù‚Ø¯Ø± Ø£Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ù€ Firebase Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ¬Ø±Ø¨.</div>

        <div class="players-inline" style="margin-top:14px">
          <div style="text-align:center;min-width:140px">
            <div style="font-weight:800">Ø§Ù„ÙØ±ÙŠÙ‚ A</div>
            <div id="previewA" class="player-pill" style="margin-top:6px">ÙØ§Ø±Øº</div>
            <div style="color:var(--muted);font-size:12px;margin-top:6px" id="previewACount">0 / 3</div>
          </div>
          <div style="width:18px"></div>
          <div style="text-align:center;min-width:140px">
            <div style="font-weight:800">Ø§Ù„ÙØ±ÙŠÙ‚ B</div>
            <div id="previewB" class="player-pill" style="margin-top:6px">ÙØ§Ø±Øº</div>
            <div style="color:var(--muted);font-size:12px;margin-top:6px" id="previewBCount">0 / 2</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="app" role="application" aria-label="Ù…Ø®Ø§ÙˆÙŠØ± ÙÙŠÙˆØ¯ â€” Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©">
    <header>
      <div>
        <div class="title">Ù…Ø®Ø§ÙˆÙŠØ± ÙÙŠÙˆØ¯ â€” Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙˆÙŠØ¨</div>
        <div class="subtitle">Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØªØ­ÙƒÙ…. Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø²Ø± Ø¬Ø±Ø³ ÙÙ‚Ø·.</div>
      </div>
    </header>

    <div class="layout">
      <aside class="panel controls" aria-label="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…">
        <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©</h3>

        <div class="row">
          <input id="teamAName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ Ø£" value="Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±" />
          <input id="teamBName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ Ø¨" value="Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚" />
        </div>

        <div class="teams">
          <div class="team-card">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div id="teamADisplay" style="font-weight:800">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</div>
              <div style="font-size:13px;color:var(--muted)">A (3)</div>
            </div>
            <div class="team-score" id="teamAScore">0</div>
            <div class="players-list" id="teamAPlayers">Ù„Ø§Ø¹Ø¨ÙˆÙ†: â€”</div>
          </div>

          <!-- bell in middle -->
          <div style="display:flex;align-items:center;justify-content:center;flex-direction:column;">
            <div id="bellContainer">
              <button id="bellBtn" class="hidden">ğŸ”” Ø¬Ø±Ø³</button>
            </div>

            <!-- manager sees queue -->
            <div id="mgrBuzzArea" class="buzz-queue hidden">
              <div style="font-weight:800;margin-bottom:6px">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¬Ø±Ø³ (Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©)</div>
              <div id="buzzList">Ù„Ø§ Ø£Ø­Ø¯ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>
            </div>
          </div>

          <div class="team-card">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div id="teamBDisplay" style="font-weight:800">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚</div>
              <div style="font-size:13px;color:var(--muted)">B (2)</div>
            </div>
            <div class="team-score" id="teamBScore">0</div>
            <div class="players-list" id="teamBPlayers">Ù„Ø§Ø¹Ø¨ÙˆÙ†: â€”</div>
          </div>
        </div>

        <div id="mgrControls">
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <button class="btn small btn-action" id="newRound">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <button class="btn small" id="resetScores">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ù‚Ø§Ø·</button>
          </div>

          <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
            <div style="font-size:13px;color:var(--muted)">Ø¯ÙˆØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø¢Ù†:</div>
            <select id="turnSelector" class="input" style="max-width:160px;padding:8px">
              <option value="A">Ø§Ù„ÙØ±ÙŠÙ‚ A</option>
              <option value="B">Ø§Ù„ÙØ±ÙŠÙ‚ B</option>
            </select>
          </div>

          <h3>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ù‚Ø§Ø¦Ù…Ø©)</h3>
          <div class="questions" id="questionsList" aria-live="polite"></div>

          <h3>Ø£Ø¶Ù Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</h3>
          <input id="qText" class="input" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..." />
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="ansText" class="input" placeholder="Ø§Ù„ØµÙŠØºØ©: Ø¥Ø¬Ø§Ø¨Ø©|Ù†Ù‚Ø§Ø·, Ø¥Ø¬Ø§Ø¨Ø©2|Ù†Ù‚Ø§Ø·2 ..." />
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addQ" class="btn small">Ø£Ø¶Ù Ø§Ù„Ø³Ø¤Ø§Ù„</button>
            <button id="importSample" class="btn small">ØªØ­Ù…ÙŠÙ„ Ø£Ù…Ø«Ù„Ø©</button>
          </div>

          <div class="hint">Ù…Ø«Ø§Ù„: ØªÙØ§Ø­|35, Ù…ÙˆØ²|28, Ø¨Ø±ØªÙ‚Ø§Ù„|18</div>

          <div style="height:12px"></div>
          <h3>Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¬ÙˆÙ„Ø©</h3>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <button class="btn small" id="revealNext">ÙƒØ´Ù Ø§Ù„ØªØ§Ù„ÙŠ</button>
            <button class="btn small" id="flipAll">ÙƒØ´Ù Ø§Ù„ÙƒÙ„</button>
          </div>

          <div class="controls-footer">
            <button class="btn small btn-action" id="awardA">Ø£Ø¶Ù Ù†Ù‚Ø§Ø· Ù„Ù„ÙØ±ÙŠÙ‚ A</button>
            <button class="btn small btn-action" id="awardB">Ø£Ø¶Ù Ù†Ù‚Ø§Ø· Ù„Ù„ÙØ±ÙŠÙ‚ B</button>
            <button class="btn small btn-red" id="strike">Ø®Ø·Ø£ / Ø³ØªØ±Ø§ÙŠÙƒ</button>
          </div>

          <div style="margin-top:8px">
            <button id="stealSuccess" class="btn small btn-action hidden">Ù†Ø¬Ø­ÙˆØ§ ÙÙŠ Ø§Ù„Ø³Ø±Ù‚Ø© (Ù…Ù†Ø­ Ø§Ù„Ù†Ù‚Ø§Ø·)</button>
          </div>

          <footer style="margin-top:10px">Ø¶Ø¹ ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø§Ø³Ù… <code>background.png</code> ÙˆÙ…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯.</footer>

          <div style="margin-top:8px">
            <button id="exportBtn" class="btn small">ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (JSON)</button>
            <label class="btn small" style="margin-right:8px">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON
              <input id="importFile" type="file" accept=".json" style="display:none">
            </label>
          </div>
        </div>

        <!-- user controls (hidden to players) -->
        <div id="playerOnlyNote" class="hidden" style="margin-top:12px;color:var(--muted);font-size:13px">
          Ø£Ù†Øª ÙÙŠ Ø¯ÙˆØ± Ù„Ø§Ø¹Ø¨ â€” Ø§Ù„ØªØ­ÙƒÙ… Ù…Ø­Ø¬ÙˆØ¨. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø¬Ø±Ø³ Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.
        </div>

      </aside>

      <main class="panel board" aria-label="Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶">
        <div class="board-top">
          <div>
            <div class="big-question" id="qDisplay">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙŠØ³Ø±Ù‰ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©</div>
            <div class="subtitle" id="qMeta">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª: â€”</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:13px;color:var(--muted)">Ø­Ø§Ù„Ø© Ø§Ù„Ø¬ÙˆÙ„Ø©</div>
            <div id="roundState" style="font-weight:800; font-size:18px">Ø¬Ø§Ù‡Ø²</div>
            <div id="currentResponder" style="margin-top:6px;color:var(--muted);font-size:13px">Ù„Ø§ Ø£Ø­Ø¯ Ù…Ø¬Ø§Ø² Ø­Ø§Ù„ÙŠØ§Ù‹</div>
          </div>
        </div>

        <div class="answers" id="answersGrid" aria-live="polite">
          <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button class="btn btn-action" id="prevReveal">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <button class="btn" id="clearReveal">Ù…Ø³Ø­ ÙƒØ´Ù</button>
        </div>
      </main>
    </div>
  </div>

<script>
/* =======================================================
   Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù‘Ù†Ø©: Ù…Ø¯ÙŠØ± + Ù„Ø§Ø¹Ø¨ + Ø¬Ø±Ø³ (Ù…Ø­Ù„ÙŠ). Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±Ø¨Ø· Firebase
   ======================================================= */

/* -------------------------
   Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ù‚ Ùˆ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
   ------------------------- */
const team = {
  A: { name: 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±', score: 0, players: [], maxPlayers: 3 },
  B: { name: 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚', score: 0, players: [], maxPlayers: 2 }
};

/* Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© */
let questions = [];
let current = { index: -1, revealed: [], strikes: 0, stealMode: false, stealBy: null, boardPoints: 0 };
let currentAnsweringTeam = 'A';

/* ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© */
let my = {
  name: null,
  role: null, // 'manager' | 'playerA' | 'playerB'
  teamKey: null // 'A'|'B' or null for manager
};

/* Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† Ø¶ØºØ·ÙˆØ§ Ø§Ù„Ø¬Ø±Ø³ (Ù…Ø­Ù„ÙŠØ§Ù‹) */
let buzzQueue = []; // [{name, team, time}]

/* Ø¹Ù†Ø§ØµØ± DOM */
const qListEl = document.getElementById('questionsList');
const qDisplay = document.getElementById('qDisplay');
const qMeta = document.getElementById('qMeta');
const answersGrid = document.getElementById('answersGrid');
const roundStateEl = document.getElementById('roundState');
const currentResponderEl = document.getElementById('currentResponder');

const teamADisplay = document.getElementById('teamADisplay');
const teamBDisplay = document.getElementById('teamBDisplay');
const teamAScoreEl = document.getElementById('teamAScore');
const teamBScoreEl = document.getElementById('teamBScore');
const teamAPlayersEl = document.getElementById('teamAPlayers');
const teamBPlayersEl = document.getElementById('teamBPlayers');

const welcomeOverlay = document.getElementById('welcomeOverlay');
const playerNameInput = document.getElementById('playerNameInput');
const joinAButton = document.getElementById('joinA');
const joinBButton = document.getElementById('joinB');
const beManagerBtn = document.getElementById('beManager');
const previewA = document.getElementById('previewA');
const previewB = document.getElementById('previewB');
const previewACount = document.getElementById('previewACount');
const previewBCount = document.getElementById('previewBCount');

const bellBtn = document.getElementById('bellBtn');
const mgrBuzzArea = document.getElementById('mgrBuzzArea');
const buzzListEl = document.getElementById('buzzList');

const mgrControls = document.getElementById('mgrControls');
const playerOnlyNote = document.getElementById('playerOnlyNote');

/* Ø§Ù„Ø£ØµÙˆØ§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
const correctSound = new Audio('correct.mp3');
const wrongSound = new Audio('wrong.mp3');
const applauseSound = new Audio('applause.mp3');
const bgMusic = new Audio('bg.mp3');
bgMusic.loop = true; bgMusic.volume = 0.28;
document.addEventListener('click', ()=> { if(bgMusic.paused) bgMusic.play().catch(()=>{}); });

function tryPlay(sound){ sound.currentTime = 0; sound.play().catch(()=>{}); }

/* -------------------------
   Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
   ------------------------- */
function saveLocalState(){
  // Ù†Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø¯ÙˆØ± ÙÙŠ localStorage Ø­ØªÙ‰ ØªØ¨Ù‚Ù‰ Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
  localStorage.setItem('mkhawir_players', JSON.stringify({A: team.A.players, B: team.B.players}));
  localStorage.setItem('mkhawir_me', JSON.stringify(my));
}
function loadLocalState(){
  try{
    const pl = JSON.parse(localStorage.getItem('mkhawir_players') || '{}');
    if(pl.A && Array.isArray(pl.A)) team.A.players = pl.A;
    if(pl.B && Array.isArray(pl.B)) team.B.players = pl.B;
    const mm = JSON.parse(localStorage.getItem('mkhawir_me') || 'null');
    if(mm && mm.name && mm.role) my = mm;
  }catch(e){}
}
function addPlayerToTeam(teamKey, playerName){
  const t = team[teamKey];
  if(!playerName || !playerName.trim()) { alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… ØµØ­ÙŠØ­'); return false; }
  if(t.players.includes(playerName)) { alert('Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„'); return false; }
  if(t.players.length >= t.maxPlayers) { alert(`Ø§Ù„ÙØ±ÙŠÙ‚ Ù…Ù…ØªÙ„Ø¦. Ø§Ù„Ø­Ø¯: ${t.maxPlayers}`); return false; }
  t.players.push(playerName);
  updatePlayersDisplay();
  saveLocalState();
  return true;
}
function removePlayerFromTeam(teamKey, playerName){
  const t = team[teamKey];
  t.players = t.players.filter(p => p !== playerName);
  updatePlayersDisplay();
  saveLocalState();
}
function updatePlayersDisplay(){
  teamAPlayersEl.textContent = 'Ù„Ø§Ø¹Ø¨ÙˆÙ†: ' + (team.A.players.length ? team.A.players.join(' ØŒ ') : 'â€”');
  teamBPlayersEl.textContent = 'Ù„Ø§Ø¹Ø¨ÙˆÙ†: ' + (team.B.players.length ? team.B.players.join(' ØŒ ') : 'â€”');
  teamAScoreEl.textContent = team.A.score;
  teamBScoreEl.textContent = team.B.score;
  previewA.textContent = team.A.players.length ? team.A.players.join(' ØŒ ') : 'ÙØ§Ø±Øº';
  previewB.textContent = team.B.players.length ? team.B.players.join(' ØŒ ') : 'ÙØ§Ø±Øº';
  previewACount.textContent = `${team.A.players.length} / ${team.A.maxPlayers}`;
  previewBCount.textContent = `${team.B.players.length} / ${team.B.maxPlayers}`;
}

/* -------------------------
   Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± (manager Ø£Ùˆ player)
   ------------------------- */
function setUIForRole(){
  // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù†Ø®ÙÙŠ ÙƒÙ„ Ø´ÙŠØ¡ Ù…ØªØ¹Ù„Ù‚ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ± Ø£Ùˆ Ø§Ù„Ù„Ø§Ø¹Ø¨
  bellBtn.classList.add('hidden');
  mgrBuzzArea.classList.add('hidden');
  mgrControls.classList.add('hidden');
  playerOnlyNote.classList.add('hidden');

  if(my.role === 'manager'){
    // Ù…Ø¯ÙŠØ±: ÙŠØ¸Ù‡Ø± ÙƒÙ„ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© + Ù„ÙˆØ­Ø© ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¬Ø±Ø³
    welcomeOverlay.classList.add('hidden');
    mgrControls.classList.remove('hidden');
    mgrBuzzArea.classList.remove('hidden');
    bellBtn.classList.add('hidden'); // Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ø¬Ø±Ø³
  } else if(my.role === 'playerA' || my.role === 'playerB'){
    // Ù„Ø§Ø¹Ø¨: Ù†Ø¸Ù‡Ø± Ø²Ø± Ø§Ù„Ø¬Ø±Ø³ (Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¶ØºØ·) Ù„ÙƒÙ† Ù†Ø®ÙÙŠ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
    welcomeOverlay.classList.add('hidden');
    bellBtn.classList.remove('hidden');
    bellBtn.classList.add('player');
    playerOnlyNote.classList.remove('hidden');
    mgrControls.classList.add('hidden');
    mgrBuzzArea.classList.add('hidden');
  } else {
    // Ù„Ù… ÙŠØ­Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ± => Ù†Ø¸Ù‡Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
    welcomeOverlay.classList.remove('hidden');
  }
}

/* -------------------------
   Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… (ØµÙØ­Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨)
   ------------------------- */
joinAButton.addEventListener('click', ()=>{
  const name = playerNameInput.value.trim();
  if(!name){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø«Ù… Ø§Ù†Ø¶Ù…'); return; }
  const ok = addPlayerToTeam('A', name);
  if(ok){
    my.name = name; my.role = 'playerA'; my.teamKey = 'A';
    saveLocalState(); setUIForRole();
    alert('Ø§Ù†Ø¶Ù…Ù…Øª Ù„Ù„ÙØ±ÙŠÙ‚ A. Ø§Ø¶ØºØ· Ø§Ù„Ø¬Ø±Ø³ Ø¹Ù†Ø¯Ù…Ø§ ØªØ±ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.');
  }
});
joinBButton.addEventListener('click', ()=>{
  const name = playerNameInput.value.trim();
  if(!name){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø«Ù… Ø§Ù†Ø¶Ù…'); return; }
  const ok = addPlayerToTeam('B', name);
  if(ok){
    my.name = name; my.role = 'playerB'; my.teamKey = 'B';
    saveLocalState(); setUIForRole();
    alert('Ø§Ù†Ø¶Ù…Ù…Øª Ù„Ù„ÙØ±ÙŠÙ‚ B. Ø§Ø¶ØºØ· Ø§Ù„Ø¬Ø±Ø³ Ø¹Ù†Ø¯Ù…Ø§ ØªØ±ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.');
  }
});
beManagerBtn.addEventListener('click', ()=>{
  const name = playerNameInput.value.trim();
  if(!name){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ (Ø³ÙŠØ¸Ù‡Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±)'); return; }
  my.name = name; my.role = 'manager'; my.teamKey = null;
  saveLocalState(); setUIForRole();
  alert('Ø£Ù†Øª Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¢Ù† â€” Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©.');
});

/* -------------------------
   Ø¬Ø±Ø³ (buzz) â€” Ø¹Ù…Ù„ÙŠØ§Ù‹ Ù…Ø­Ù„ÙŠ
   ------------------------- */
function renderBuzzQueue(){
  if(buzzQueue.length === 0){
    buzzListEl.innerHTML = 'Ù„Ø§ Ø£Ø­Ø¯ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.';
    return;
  }
  // ÙƒÙ„ Ø¹Ù†ØµØ±: Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… + ÙØ±ÙŠÙ‚ + Ø£Ø²Ø±Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© / Ø±ÙØ¶
  buzzListEl.innerHTML = '';
  buzzQueue.forEach((b, idx) => {
    const div = document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center';
    div.style.padding='6px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<div><strong>${escapeHtml(b.name)}</strong> â€” ${b.team === 'A' ? 'Ø§Ù„ÙØ±ÙŠÙ‚ A' : 'Ø§Ù„ÙØ±ÙŠÙ‚ B'} <span style="color:var(--muted);font-size:12px;margin-left:8px">(${new Date(b.time).toLocaleTimeString()})</span></div>`;
    const controls = document.createElement('div');
    const approve = document.createElement('button');
    approve.textContent = 'Ù…ÙˆØ§ÙÙ‚Ø©';
    approve.className = 'btn small btn-action';
    approve.style.marginLeft = '8px';
    approve.onclick = ()=> { approveBuzz(idx); };
    const reject = document.createElement('button');
    reject.textContent = 'Ø±ÙØ¶';
    reject.className = 'btn small btn-red';
    reject.onclick = ()=> { rejectBuzz(idx); };
    controls.appendChild(approve); controls.appendChild(reject);
    div.appendChild(controls);
    buzzListEl.appendChild(div);
  });
}

/* player clicks bell */
bellBtn.addEventListener('click', ()=>{
  if(!my.name || !my.teamKey){ alert('Ù„Ø§ Ø¨Ø¯ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ù†Ø¶Ù…Ù‹Ø§ Ù„ÙØ±ÙŠÙ‚ Ù„ØªØ¶ØºØ· Ø§Ù„Ø¬Ø±Ø³'); return; }
  // Ø¥Ø°Ø§ Ø£Ù†Ø§ Ù„Ø§Ø¹Ø¨: Ø£Ø¶ÙŠÙ Ø·Ù„Ø¨ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø·Ø§Ø¨ÙˆØ± (Ù…Ø­Ù„ÙŠ)
  // Ø¥Ø°Ø§ Ø³Ø¨Ù‚ ÙˆØ·Ù„Ø¨Øª ÙÙ„Ø§ Ø£Ø¹ÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
  const already = buzzQueue.some(b => b.name === my.name && b.team === my.teamKey);
  if(already){ alert('Ù„Ù‚Ø¯ Ø·Ù„Ø¨Øª Ø¨Ø§Ù„ÙØ¹Ù„ â€” Ø§Ù†ØªØ¸Ø± Ø±Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±'); return; }
  const b = { name: my.name, team: my.teamKey, time: Date.now() };
  buzzQueue.push(b);
  renderBuzzQueue();
  // Ù„Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ± Ù…ÙØªÙˆØ­ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø³ÙŠØ±Ù‰ Ø§Ù„Ø·Ø§Ø¨ÙˆØ± Ù…Ø¨Ø§Ø´Ø±Ø©
  alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¬Ø±Ø³Ùƒ â€” Ø§Ù†ØªØ¸Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø¯ÙŠØ±.');
});

/* manager approves */
function approveBuzz(index){
  if(index < 0 || index >= buzzQueue.length) return;
  const b = buzzQueue.splice(index,1)[0];
  // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØµØ±Ø­ Ù„Ù‡ Ø§Ù„Ø¢Ù†
  currentResponderEl.textContent = `Ù…ØµØ±Ø­ Ø¨Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: ${b.name} â€” ${b.team === 'A' ? team.A.name : team.B.name}`;
  // ØªØ¹ÙŠÙŠÙ† Ø¯ÙˆØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù„Ù„ÙØ±ÙŠÙ‚ Ù„Ùˆ Ø±ØºØ¨Øª
  currentAnsweringTeam = b.team;
  document.getElementById('turnSelector').value = b.team;
  roundStateEl.textContent = `Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù„Ø¹Ø¨ - Ø¯ÙˆØ± ${team[b.team].name}`;
  renderBuzzQueue();
  // Ø­ÙØ¸ ÙÙŠ localStorage (Ù„ÙŠÙƒÙˆÙ† Ø¨Ø§Ù‚ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„)
  saveLocalState();
}

/* manager rejects */
function rejectBuzz(index){
  if(index < 0 || index >= buzzQueue.length) return;
  const b = buzzQueue.splice(index,1)[0];
  alert(`ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ ${b.name}`);
  renderBuzzQueue();
}

/* -------------------------
   Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø±Ø¶ (Ù…Ù†Ø³ÙˆØ®Ø© ÙˆÙ…Ø¹ØªØ§Ø¯Ø©)
   ------------------------- */
function renderQuestions(){
  qListEl.innerHTML='';
  questions.forEach((qq,i)=>{
    const d = document.createElement('div'); d.className='question-item';
    d.innerHTML = `<div style="font-weight:700">${escapeHtml(qq.q)}</div><div style="color:var(--muted);font-size:13px">${qq.answers.length} Ø¥Ø¬Ø§Ø¨Ø§Øª</div>`;
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©
    d.addEventListener('click', ()=> {
      if(my.role !== 'manager'){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ³ØªØ·ÙŠØ¹ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©'); return; }
      startRound(i);
    });
    qListEl.appendChild(d);
  });
}
function parseAnswers(text){
  const parts = text.split(',').map(s=>s.trim()).filter(Boolean);
  return parts.map(p=>{
    const [t,pts] = p.split('|').map(x=>x && x.trim());
    return {text: t||'â€”', pts: Number(pts||0)}
  })
}
document.getElementById('addQ').addEventListener('click', ()=>{
  if(my.role !== 'manager'){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ³ØªØ·ÙŠØ¹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©'); return; }
  const q = document.getElementById('qText').value.trim();
  const a = document.getElementById('ansText').value.trim();
  if(!q || !a){alert('Ø§Ù…Ù„Ø£ Ø§Ù„Ø³Ø¤Ø§Ù„ Ùˆ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª');return}
  questions.push({q, answers: parseAnswers(a)});
  document.getElementById('qText').value=''; document.getElementById('ansText').value='';
  renderQuestions();
});
document.getElementById('importSample').addEventListener('click', ()=>{
  if(my.role !== 'manager'){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©'); return; }
  questions = sampleQuestions(); renderQuestions(); alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¦Ù„Ø© Ù†Ù…ÙˆØ°Ø¬ÙŠØ©. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©.');
});
function sampleQuestions(){
  return [
    { q: "Ø´ÙŠ ØªÙ„Ù‚Ø§Ù‡ ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø³", answers: [{text:"Ø¯Ù„Ø© Ù‚Ù‡ÙˆØ©",pts:30},{text:"ØªÙ…Ø±",pts:20},{text:"Ù…Ø³Ø§Ù†Ø¯",pts:15},{text:"Ø³Ø¬Ø§Ø¯",pts:10},{text:"Ø¨Ø®ÙˆØ±",pts:8},{text:"ØªÙ„ÙØ²ÙŠÙˆÙ†",pts:5}] },
    { q: "Ø´ÙŠ ØªØ³ÙˆÙŠÙ‡ Ø£ÙˆÙ„ Ù…Ø§ ØªØµØ­Ù‰ Ù…Ù† Ø§Ù„Ù†ÙˆÙ…", answers: [{text:"ØªÙØªØ­ Ø§Ù„Ø¬ÙˆØ§Ù„",pts:25},{text:"ØªØµÙ„ÙŠ Ø§Ù„ÙØ¬Ø±",pts:20},{text:"ØªØºØ³Ù„ ÙˆØ¬Ù‡Ùƒ",pts:18},{text:"ØªØ´Ø±Ø¨ Ù…Ø§Ø¡",pts:15},{text:"ØªÙØ±Ø´ Ø£Ø³Ù†Ø§Ù†Ùƒ",pts:10}] },
    { q: "Ø£ÙƒÙ„Ø© Ø´Ø¹Ø¨ÙŠØ© Ø³Ø¹ÙˆØ¯ÙŠØ©", answers: [{text:"ÙƒØ¨Ø³Ø©",pts:35},{text:"Ø¬Ø±ÙŠØ´",pts:20},{text:"Ù‚Ø±ØµØ§Ù†",pts:15},{text:"Ù…Ù†Ø¯ÙŠ",pts:12},{text:"Ù…Ø±Ø§ØµÙŠØ¹",pts:8}] }
  ];
}

/* Ø¹Ø±Ø¶ Ø§Ù„Ø¬ÙˆÙ„Ø© Ùˆ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª */
function startRound(index){
  if(my.role !== 'manager'){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ³ØªØ·ÙŠØ¹ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©'); return; }
  current.index = index; current.revealed = []; current.strikes = 0; current.stealMode = false; current.stealBy = null; current.boardPoints = 0;
  const q = questions[index];
  qDisplay.textContent = q.q;
  qMeta.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª: ${q.answers.length}`;
  renderAnswers();
  roundStateEl.textContent = `Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù„Ø¹Ø¨ - Ø¯ÙˆØ± ${ team[currentAnsweringTeam].name }`;
  document.getElementById('stealSuccess').classList.add('hidden');
  // Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† ÙŠØ¬ÙŠØ¨ Ø¹Ø¨Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø±Ø³ØŒ Ø£Ùˆ ÙŠØ¶ØºØ· Award Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¬ÙŠØ¨ Ø§Ù„ÙØ±ÙŠÙ‚
}
function renderAnswers(){
  answersGrid.innerHTML='';
  if(current.index===-1) return;
  const arr = questions[current.index].answers;
  arr.forEach((a,i)=>{
    const el = document.createElement('div'); el.className='answer';
    if(current.revealed.includes(i)) el.classList.add('revealed');
    // Ø¥Ø¬Ø§Ø¨Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ù‚Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ±
    const txt = current.revealed.includes(i) ? escapeHtml(a.text) : 'â€”';
    const pts = current.revealed.includes(i) ? (a.pts || '') : '';
    el.innerHTML = `<div class="txt">${txt}</div><div class="pts">${pts}</div>`;
    el.addEventListener('click', ()=> {
      if(my.role !== 'manager'){ return; } // Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ù„Ø§ ÙŠÙ‚Ø¯Ø±ÙˆÙ† ÙŠÙƒØ´ÙÙˆÙ†
      toggleReveal(i);
    });
    answersGrid.appendChild(el);
  })
}
function toggleReveal(i){
  if(current.index===-1) return;
  if(!current.revealed.includes(i)){
    current.revealed.push(i);
    tryPlay(correctSound);
    flashGreen();
    if(current.revealed.length === questions[current.index].answers.length){
      tryPlay(applauseSound);
      throwConfetti();
    }
  } else {
    current.revealed = current.revealed.filter(x=>x!==i);
  }
  renderAnswers();
}
document.getElementById('revealNext').addEventListener('click', ()=>{
  if(my.role !== 'manager'){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ³ØªØ·ÙŠØ¹ ÙƒØ´Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª'); return; }
  if(current.index===-1) return alert('Ø§Ø®ØªØ± Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹');
  const total = questions[current.index].answers.length;
  for(let i=0;i<total;i++){
    if(!current.revealed.includes(i)){ current.revealed.push(i); tryPlay(correctSound); break; }
  }
  if(current.revealed.length === questions[current.index].answers.length){ tryPlay(applauseSound); throwConfetti(); }
  renderAnswers();
});
document.getElementById('flipAll').addEventListener('click', ()=>{
  if(my.role !== 'manager'){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ³ØªØ·ÙŠØ¹ ÙƒØ´Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª'); return; }
  if(current.index===-1) return alert('Ø§Ø®ØªØ± Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹');
  current.revealed = questions[current.index].answers.map((_,i)=>i);
  renderAnswers();
  tryPlay(applauseSound);
  throwConfetti();
});
document.getElementById('clearReveal').addEventListener('click', ()=>{ current.revealed = []; renderAnswers(); roundStateEl.textContent='Ø¬Ø§Ù‡Ø²'; });

/* previous reveal */
document.getElementById('prevReveal').addEventListener('click', ()=>{
  if(my.role !== 'manager'){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ³ØªØ·ÙŠØ¹ Ø°Ù„Ùƒ'); return; }
  if(current.revealed.length===0) return;
  current.revealed.pop(); renderAnswers();
});

/* -------------------------
   Ù†Ù‚Ø§Ø· Ùˆ Ø³ØªØ±Ø§ÙŠÙƒ Ùˆ Ø³Ø±Ù‚Ø©
   ------------------------- */
function updateScores(){ teamAScoreEl.textContent = team.A.score; teamBScoreEl.textContent = team.B.score; saveLocalState(); }

document.getElementById('awardA').addEventListener('click', ()=>{
  if(my.role !== 'manager'){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ³ØªØ·ÙŠØ¹ Ù…Ù†Ø­ Ø§Ù„Ù†Ù‚Ø§Ø·'); return; }
  if(current.index===-1) return alert('Ù„Ø§ Ø¬ÙˆÙ„Ø©');
  if(current.stealMode && current.stealBy === 'A'){
    tryPlay(correctSound); flashGreen();
    team.A.score += current.boardPoints; updateScores();
    alert(`${team.A.name} Ù†Ø¬Ø­ ÙÙŠ Ø§Ù„Ø³Ø±Ù‚Ø© ÙˆØ­ØµÙ„ Ø¹Ù„Ù‰ ${current.boardPoints} Ù†Ù‚Ø·Ø©`);
    current.stealMode = false; roundStateEl.textContent = 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©';
    document.getElementById('stealSuccess').classList.add('hidden'); return;
  }
  const pts = current.revealed.reduce((s,i)=> s + (questions[current.index].answers[i].pts||0),0);
  team.A.score += pts; updateScores(); tryPlay(applauseSound); throwConfetti();
  alert(`Ø£Ø¹Ø·ÙŠØª ${pts} Ù†Ù‚Ø·Ø© Ù„Ù€ ${team.A.name}`);
});
document.getElementById('awardB').addEventListener('click', ()=>{
  if(my.role !== 'manager'){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ³ØªØ·ÙŠØ¹ Ù…Ù†Ø­ Ø§Ù„Ù†Ù‚Ø§Ø·'); return; }
  if(current.index===-1) return alert('Ù„Ø§ Ø¬ÙˆÙ„Ø©');
  if(current.stealMode && current.stealBy === 'B'){
    tryPlay(correctSound); flashGreen();
    team.B.score += current.boardPoints; updateScores();
    alert(`${team.B.name} Ù†Ø¬Ø­ ÙÙŠ Ø§Ù„Ø³Ø±Ù‚Ø© ÙˆØ­ØµÙ„ Ø¹Ù„Ù‰ ${current.boardPoints} Ù†Ù‚Ø·Ø©`);
    current.stealMode = false; roundStateEl.textContent = 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©';
    document.getElementById('stealSuccess').classList.add('hidden'); return;
  }
  const pts = current.revealed.reduce((s,i)=> s + (questions[current.index].answers[i].pts||0),0);
  team.B.score += pts; updateScores(); tryPlay(applauseSound); throwConfetti();
  alert(`Ø£Ø¹Ø·ÙŠØª ${pts} Ù†Ù‚Ø·Ø© Ù„Ù€ ${team.B.name}`);
});
document.getElementById('strike').addEventListener('click', ()=>{
  if(my.role !== 'manager'){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ³ØªØ·ÙŠØ¹ Ø°Ù„Ùƒ'); return; }
  if(current.index===-1) return alert('Ù„Ø§ Ø¬ÙˆÙ„Ø©');
  if(current.stealMode){
    tryPlay(wrongSound);
    const original = (current.stealBy === 'A') ? 'B' : 'A';
    team[original].score += current.boardPoints; updateScores();
    alert(`${team[current.stealBy].name} Ø£Ø®ÙÙ‚ ÙÙŠ Ø§Ù„Ø³Ø±Ù‚Ø©. ${team[original].name} ÙŠØ­ØªÙØ¸ Ø¨Ù€ ${current.boardPoints} Ù†Ù‚Ø·Ø©`);
    current.stealMode = false; current.stealBy = null; current.boardPoints = 0; roundStateEl.textContent = 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©';
    document.getElementById('stealSuccess').classList.add('hidden'); return;
  }
  current.strikes = (current.strikes || 0) + 1; tryPlay(wrongSound);
  roundStateEl.textContent = `Ø£Ø®Ø·Ø§Ø¡: ${current.strikes} â€” Ø¯ÙˆØ± ${team[currentAnsweringTeam].name}`;
  if(current.strikes >= 3){
    const other = (currentAnsweringTeam === 'A') ? 'B' : 'A';
    current.stealMode = true; current.stealBy = other;
    current.boardPoints = questions[current.index].answers.reduce((s,a)=> s + (a.pts||0), 0);
    roundStateEl.textContent = `Ø¬ÙˆÙ„Ø© Ø§Ù„Ø³Ø±Ù‚Ø© - Ø¯ÙˆØ± ${team[other].name}`;
    alert(`3 Ø³ØªØ±Ø§ÙŠÙƒ! Ø§Ù„Ø¢Ù† Ø¯ÙˆØ± ${team[other].name} ÙÙŠ Ø¬ÙˆÙ„Ø© Ø§Ù„Ø³Ø±Ù‚Ø© (Ø§Ù„Ù‚ÙŠÙ…Ø©: ${current.boardPoints} Ù†Ù‚Ø·Ø©).`);
    document.getElementById('stealSuccess').classList.remove('hidden');
  }
});
document.getElementById('stealSuccess').addEventListener('click', ()=>{
  if(my.role !== 'manager'){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ³ØªØ·ÙŠØ¹ Ø°Ù„Ùƒ'); return; }
  if(!current.stealMode) return;
  const winner = current.stealBy; tryPlay(correctSound); flashGreen();
  team[winner].score += current.boardPoints; updateScores();
  alert(`${team[winner].name} Ù†Ø¬Ø­ÙˆØ§ ÙÙŠ Ø§Ù„Ø³Ø±Ù‚Ø© ÙˆØ­ØµÙ„ÙˆØ§ Ø¹Ù„Ù‰ ${current.boardPoints} Ù†Ù‚Ø·Ø©`);
  current.stealMode = false; current.stealBy = null; current.boardPoints = 0; roundStateEl.textContent = 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©';
  document.getElementById('stealSuccess').classList.add('hidden');
});

/* new round / reset scores */
document.getElementById('newRound').addEventListener('click', ()=>{
  if(my.role !== 'manager'){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ³ØªØ·ÙŠØ¹ Ø°Ù„Ùƒ'); return; }
  current.index=-1; current.revealed=[]; current.strikes=0; current.stealMode=false; current.stealBy=null; current.boardPoints=0;
  qDisplay.textContent='Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙŠØ³Ø±Ù‰ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©'; qMeta.textContent='â€”'; answersGrid.innerHTML=''; roundStateEl.textContent='Ø¬Ø§Ù‡Ø²';
  document.getElementById('stealSuccess').classList.add('hidden');
});
document.getElementById('resetScores').addEventListener('click', ()=>{ if(my.role !== 'manager'){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ³ØªØ·ÙŠØ¹ Ø°Ù„Ùƒ'); return; } if(confirm('Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ù‚Ø§Ø·ØŸ')){ team.A.score=0; team.B.score=0; updateScores(); } });

/* export / import */
function exportJSON(){ const data = JSON.stringify(questions, null, 2); const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='mkhawir_questions.json'; a.click(); URL.revokeObjectURL(url); }
document.getElementById('exportBtn').addEventListener('click', ()=>{ if(my.role !== 'manager'){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ³ØªØ·ÙŠØ¹ Ø°Ù„Ùƒ'); return; } exportJSON(); });
document.getElementById('importFile').addEventListener('change', (e)=>{ if(my.role !== 'manager'){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ³ØªØ·ÙŠØ¹ Ø°Ù„Ùƒ'); return; } const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = ev => { try { const parsed = JSON.parse(ev.target.result); if(Array.isArray(parsed)) { questions = parsed; renderQuestions(); alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©'); } else alert('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­'); } catch(err){ alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'); } }; reader.readAsText(file); });

/* initialize sample data + local load */
loadLocalState();
questions = sampleQuestions();
renderQuestions();
updatePlayersDisplay();
setUIForRole();
renderBuzzQueue();

/* -------------------------
   Confetti Ùˆ ÙÙ„Ø§Ø´ Ø£Ø®Ø¶Ø±
   ------------------------- */
function flashGreen(){ document.body.classList.add('flash-green'); setTimeout(()=>document.body.classList.remove('flash-green'), 350); }
const confCanvas = document.getElementById('confetti'); const ctx = confCanvas.getContext('2d'); let confettiPieces = []; function resizeCanvas(){ confCanvas.width = window.innerWidth; confCanvas.height = window.innerHeight; } window.addEventListener('resize', resizeCanvas); resizeCanvas();
function throwConfetti(){ const count = 90; for(let i=0;i<count;i++) confettiPieces.push(createPiece()); if(!animating){ animating=true; requestAnimationFrame(drawConfetti); } }
function createPiece(){ const w = Math.random()*10 + 6; const h = Math.random()*6 + 4; return { x: Math.random()*confCanvas.width, y: -20 - Math.random()*confCanvas.height*0.1, vx: (Math.random()-0.5)*4, vy: Math.random()*3 + 2, rot: Math.random()*360, dang: (Math.random()-0.5)*0.2, w, h, color: `hsl(${Math.floor(Math.random()*360)}, 70%, 60%)`, life: 0 } }
let animating = false;
function drawConfetti(){ ctx.clearRect(0,0,confCanvas.width, confCanvas.height); for(let i=confettiPieces.length-1;i>=0;i--){ const p = confettiPieces[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.06; p.rot += p.dang * 10; p.life++; ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot * Math.PI / 180); ctx.fillStyle = p.color; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore(); if(p.y > confCanvas.height + 50 || p.life > 400) confettiPieces.splice(i,1); } if(confettiPieces.length>0) requestAnimationFrame(drawConfetti); else animating=false; }

/* -------------------------
   Ø£Ù…Ø§Ù† Ø¨Ø³ÙŠØ·: ØªÙØ§Ø¯ÙŠ XSS Ù…Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ùˆ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
   ------------------------- */
function escapeHtml(str){ if(!str && str !== 0) return ''; return String(str).replace(/[&<>"'`=\/]/g, function(s){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;',"/":'&#x2F;','`':'&#x60;','=':'&#x3D;'}[s]; }); }

/* -------------------------
   ÙˆØ¸Ø§Ø¦Ù Ù…ÙÙŠØ¯Ø© Ø¥Ø¶Ø§ÙÙŠØ©
   ------------------------- */
function tryPlay(sound){ sound.currentTime = 0; sound.play().catch(()=>{}); }

/* Escape: Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© â€” Ø¥Ø²Ø§Ù„Ø© Ù„Ø§Ø¹Ø¨ (Ù…Ø¯ÙŠØ± ÙÙ‚Ø·) Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ */
function adminRemovePlayer(teamKey, playerName){
  if(confirm(`Ø­Ø°Ù ${playerName} Ù…Ù† Ø§Ù„ÙØ±ÙŠÙ‚ ${teamKey} ØŸ`)){
    removePlayerFromTeam(teamKey, playerName);
    alert('ØªÙ… Ø§Ù„Ø­Ø°Ù');
  }
}

/* Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ù„Ø§Ø¹Ø¨ ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ â€” (Ù„Ù…Ø¯Ø±Ø§Ø¡) Ù†ÙˆÙØ± Ø·Ø±ÙŠÙ‚Ø© Ù„Ù„Ø­Ø°Ù */
teamAPlayersEl.addEventListener('click', (e)=>{
  if(my.role !== 'manager') return;
  const name = prompt('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„ÙØ±ÙŠÙ‚ A (Ù†Ø³Ø®Ù‡ Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶):');
  if(name) adminRemovePlayer('A', name.trim());
});
teamBPlayersEl.addEventListener('click', (e)=>{
  if(my.role !== 'manager') return;
  const name = prompt('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„ÙØ±ÙŠÙ‚ B (Ù†Ø³Ø®Ù‡ Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶):');
  if(name) adminRemovePlayer('B', name.trim());
});

/* Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©:
   - Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹Ù…Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§: Ù„Ùˆ ÙØªØ­ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ù„Ù‰ Ø£Ø¬Ù‡Ø²Ø© Ù…Ø®ØªÙ„ÙØ© Ù„Ù† ÙŠØªØ²Ø§Ù…Ù†ÙˆØ§.
   - Ù„Ø¹Ù…Ù„ ØªØ²Ø§Ù…Ù† Ø­Ù‚ÙŠÙ‚ÙŠ: Ø§Ø³ØªØ¨Ø¯Ù„/Ø£ÙƒÙ…Ù„ Ù‚Ø³Ù… Ø§Ù„Ù€ buzzQueue Ùˆ Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø¨Ù€ Firebase Realtime DB Ø£Ùˆ WebSocket.
   - Ù„Ùˆ ØªØ­Ø¨ Ø£Ø¬Ù‡Ø² Ù„Ùƒ Ø§Ù„Ø±Ø¨Ø· Ø¨Ù€ Firebase (Ù…Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Ø¨Ø³ÙŠØ·Ø©) Ø£Ù‚Ø¯Ø± Ø£Ø¹Ù…Ù„Ù‡ ÙÙŠ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø¬Ø§ÙŠ.
*/

</script>

<!-- Firebase App (the core Firebase SDK) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyCtDSup_LvG7_JU7c18VhRH9jic3S0Qk74",
    authDomain: "mkhawirgame.firebaseapp.com",
    databaseURL: "https://mkhawirgame-default-rtdb.firebaseio.com",
    projectId: "mkhawirgame",
    storageBucket: "mkhawirgame.firebasestorage.app",
    messagingSenderId: "218585352304",
    appId: "1:218585352304:web:bc0d6cb4cf727edc1a8cb5"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  var db = firebase.database();

  // Example: Buzz button logic
  function sendBuzz(team, player) {
    db.ref("buzz").set({
      team: team,
      player: player,
      time: Date.now()
    });
  }

  function listenForBuzz() {
    db.ref("buzz").on("value", function(snapshot) {
      var data = snapshot.val();
      if (data) {
        alert(data.player + " Ù…Ù† Ø§Ù„ÙØ±ÙŠÙ‚ " + data.team + " Ø¶ØºØ· Ø§Ù„Ø¬Ø±Ø³!");
      }
    });
  }
</script>

</body>
</html>
