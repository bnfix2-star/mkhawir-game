<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>فاملي فيود — لعبة عائلية</title>
<style>
  :root{
    --card: rgba(3,8,16,0.75);
    --muted:#9aa7b8;
    --accent:#16a34a;
    --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:
      linear-gradient(180deg, rgba(2,6,23,0.75) 0%, rgba(2,6,23,0.75) 60%),
      url('background.png') repeat;
    background-size: cover;
    color:#e6eef6;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
    /* حركة بسيطة لموضع الخلفية */
    animation: moveBg 30s linear infinite;
    transition: background-color .25s ease;
  }
  @keyframes moveBg {
    from { background-position: 0 0; }
    to { background-position: 100% 0; }
  }

  .flash-green {
    animation: flashGreen 0.35s ease;
  }
  @keyframes flashGreen {
    0% { background-color: rgba(6,78,59,0.95); }
    100% { background-color: transparent; }
  }

  .app{width:100%;max-width:1200px}
  header{display:flex;gap:12px;align-items:center;margin-bottom:18px}
  .title{font-size:22px;font-weight:800}
  .subtitle{color:var(--muted);font-size:13px}

  .layout{display:grid;grid-template-columns:380px 1fr;gap:18px}
  .panel{background:var(--card);backdrop-filter: blur(6px);border-radius:14px;padding:16px;box-shadow:0 8px 30px rgba(2,6,23,0.7)}

  /* left */
  .controls h3{margin:0 0 8px 0}
  .input, .select, .btn{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;margin-bottom:8px}
  .row{display:flex;gap:8px;margin-bottom:10px}
  .small{padding:8px;font-size:13px}
  .teams{display:flex;gap:8px;margin-bottom:12px}
  .team-card{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);text-align:center}
  .team-score{font-size:20px;font-weight:900;margin-top:6px}
  .questions{max-height:260px;overflow:auto;margin-top:8px}
  .question-item{padding:10px;border-radius:10px;margin-bottom:8px;background:var(--glass-2);cursor:pointer;transition:transform .12s, background .12s}
  .question-item:hover{transform:translateY(-3px);background:rgba(255,255,255,0.035)}

  /* right */
  .board{display:flex;flex-direction:column;gap:12px}
  .board-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .big-question{font-size:22px;font-weight:800}
  .answers{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .answer{padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);min-height:68px;display:flex;align-items:center;justify-content:space-between;gap:12px;transition:all .18s;cursor:pointer}
  .answer.revealed{background:linear-gradient(90deg, rgba(22,163,74,0.12), rgba(22,163,74,0.06));border:1px solid rgba(22,163,74,0.14);transform:scale(1.02)}
  .answer .txt{font-size:16px}
  .answer .pts{font-weight:900}

  .controls-footer{display:flex;gap:8px}
  .btn-action{background:linear-gradient(90deg,#0ea5a3,#06b6d4);border:none;color:#042024;padding:10px 14px;border-radius:10px}
  .btn-red{background:linear-gradient(90deg,#ef4444,#f97316);border:none;color:white;padding:10px 14px;border-radius:10px}
  .hint{font-size:13px;color:var(--muted);margin-top:6px}

  footer{margin-top:12px;color:var(--muted);font-size:13px}

  /* confetti canvas overlay */
  #confetti {
    position:fixed;
    left:0;top:0;right:0;bottom:0;
    pointer-events:none;
    z-index:999;
  }

  .hidden{display:none !important}

  @media (max-width:920px){
    .layout{grid-template-columns:1fr;}.board{order:2}.panel{padding:12px}
    .answers{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <canvas id="confetti"></canvas>

  <div class="app" role="application" aria-label="فاملي فيود — لوحة اللعبة">
    <header>
      <div>
        <div class="title">فاملي فيود</div>
        <div class="subtitle">تصميم المبرمج الكبير رائد حاضر مسفر هيف الطوال الدوسري</div>
      </div>
    </header>

    <div class="layout">
      <aside class="panel controls" aria-label="لوحة التحكم">
        <h3>الأفرقة</h3>

        <div class="row">
          <input id="teamAName" class="input" placeholder="اسم الفريق أ" value="الفريق الأحمر" />
          <input id="teamBName" class="input" placeholder="اسم الفريق ب" value="الفريق الأزرق" />
        </div>

        <div class="teams">
          <div class="team-card">
            <div id="teamADisplay" style="font-weight:800">الفريق الأحمر</div>
            <div class="team-score" id="teamAScore">0</div>
          </div>
          <div class="team-card">
            <div id="teamBDisplay" style="font-weight:800">الفريق الأزرق</div>
            <div class="team-score" id="teamBScore">0</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="btn small btn-action" id="newRound">جولة جديدة</button>
          <button class="btn small" id="resetScores">إعادة النقاط</button>
        </div>

        <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
          <div style="font-size:13px;color:var(--muted)">دور الإجابة الآن:</div>
          <button id="setTurnA" class="btn small">فريق أ</button>
          <button id="setTurnB" class="btn small">فريق ب</button>
        </div>

        <h3>الأسئلة (قائمة)</h3>
        <div class="questions" id="questionsList" aria-live="polite"></div>

        <div style="display:flex;gap:8px;margin-top:8px">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="addQ" class="btn small">أضف السؤال</button>
          <button id="importSample" class="btn small">تحميل أمثلة</button>
        </div>

        <div class="hint">مثال: تفاح|35, موز|28, برتقال|18</div>

        <div style="height:12px"></div>
        <h3>أدوات الجولة</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="btn small" id="revealNext">كشف التالي</button>
          <button class="btn small" id="flipAll">كشف الكل</button>
        </div>

        <div class="controls-footer">
          <button class="btn small btn-action" id="awardA">أضف نقاط لفريق أ</button>
          <button class="btn small btn-action" id="awardB">أضف نقاط لفريق ب</button>
          <button class="btn small btn-red" id="strike">خطأ / سترايك</button>
        </div>

        <div style="margin-top:8px">
          <button id="stealSuccess" class="btn small btn-action hidden">نجحوا في السرقة (منح النقاط)</button>
        </div>

        <footer>ضع صورة الخلفية باسم <code>background.png</code> وملفات الصوت في نفس المجلد.</footer>

        <div style="margin-top:8px">
          <button id="exportBtn" class="btn small">تصدير الأسئلة (JSON)</button>
          <label class="btn small" style="margin-right:8px">استيراد JSON
            <input id="importFile" type="file" accept=".json" style="display:none">
          </label>
        </div>
      </aside>

      <main class="panel board" aria-label="لوحة العرض">
        <div class="board-top">
          <div>
            <div class="big-question" id="qDisplay">اضغط على سؤال من الجهة اليسرى لبدء الجولة</div>
            <div class="subtitle" id="qMeta">عدد الإجابات: —</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:13px;color:var(--muted)">حالة الجولة</div>
            <div id="roundState" style="font-weight:800; font-size:18px">جاهز</div>
          </div>
        </div>

        <div class="answers" id="answersGrid" aria-live="polite">
          <!-- بطاقات الإجابة تظهر هنا -->
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button class="btn btn-action" id="prevReveal">السابق</button>
          <button class="btn" id="clearReveal">مسح كشف</button>
        </div>
      </main>
    </div>
  </div>

<script>
/* -------------------------
  بيانات وأساليب اللعبة (معدلة ومتكاملة)
   ------------------------- */
let questions = [];
let current = {
  index: -1,
  revealed: [],
  strikes: 0,
  stealMode: false,
  stealBy: null,
  boardPoints: 0
};
// من يبدأ بالرد حالياً (A أو B). يمكنك تغييره من الأزرار.
let currentAnsweringTeam = 'A';

const team = { A: { name: 'الفريق الأحمر', score: 0 }, B: { name: 'الفريق الأزرق', score: 0 } };

const qListEl = document.getElementById('questionsList');
const qDisplay = document.getElementById('qDisplay');
const qMeta = document.getElementById('qMeta');
const answersGrid = document.getElementById('answersGrid');
const roundStateEl = document.getElementById('roundState');

document.getElementById('teamAName').addEventListener('input', e => {
  team.A.name = e.target.value; document.getElementById('teamADisplay').textContent = e.target.value || 'الفريق أ';
});
document.getElementById('teamBName').addEventListener('input', e => {
  team.B.name = e.target.value; document.getElementById('teamBDisplay').textContent = e.target.value || 'الفريق ب';
});

document.getElementById('setTurnA').addEventListener('click', ()=> {
  currentAnsweringTeam = 'A';
  roundStateEl.textContent = `جاهز - دور ${team.A.name}`;
});
document.getElementById('setTurnB').addEventListener('click', ()=> {
  currentAnsweringTeam = 'B';
  roundStateEl.textContent = `جاهز - دور ${team.B.name}`;
});

function renderQuestions(){
  qListEl.innerHTML='';
  questions.forEach((qq,i)=>{
    const d = document.createElement('div'); d.className='question-item';
    d.innerHTML = `<div style="font-weight:700">${qq.q}</div><div style="color:var(--muted);font-size:13px">${qq.answers.length} إجابات</div>`;
    d.addEventListener('click', ()=> startRound(i));
    qListEl.appendChild(d);
  });
}

function parseAnswers(text){
  const parts = text.split(',').map(s=>s.trim()).filter(Boolean);
  return parts.map(p=>{
    const [t,pts] = p.split('|').map(x=>x && x.trim());
    return {text: t||'—', pts: Number(pts||0)}
  })
}

document.getElementById('addQ').addEventListener('click', ()=>{
  const q = document.getElementById('qText').value.trim();
  const a = document.getElementById('ansText').value.trim();
  if(!q || !a){alert('املأ السؤال و الإجابات');return}
  questions.push({q, answers: parseAnswers(a)});
  document.getElementById('qText').value=''; document.getElementById('ansText').value='';
  renderQuestions();
});

document.getElementById('importSample').addEventListener('click', ()=>{
  questions = sampleQuestions(); renderQuestions(); alert('تم تحميل أسئلة نموذجية. اضغط على أي سؤال لبدء الجولة.');
});

function sampleQuestions(){
  return [
    { q: "شي تلقاه في المجلس", answers: [{text:"دلة قهوة",pts:30},{text:"تمر",pts:20},{text:"مساند",pts:15},{text:"سجاد",pts:10},{text:"بخور",pts:8},{text:"تلفزيون",pts:5}] },
    { q: "أكلة شعبية سعودية", answers: [{text:"كبسة",pts:35},{text:"جريش",pts:20},{text:"قرصان",pts:15},{text:"مندي",pts:12},{text:"مراصيع",pts:8}] },
    { q: "شي تستخدمه وقت المطر", answers: [{text:"مظلة",pts:25},{text:"مشلح",pts:20},{text:"جزمة مطر",pts:15},{text:"شماغ",pts:10},{text:"قفازات",pts:5}] },
    { q: "شي في السيارة", answers: [{text:"مقود",pts:25},{text:"مكيف",pts:20},{text:"مرايا",pts:15},{text:"إطارات",pts:10},{text:"مسجل",pts:5}] },
    { q: "مكان تروح له مع العائلة", answers: [{text:"مطعم",pts:30},{text:"منتزه",pts:25},{text:"مول",pts:20},{text:"البر",pts:15},{text:"شاليه",pts:10}] },
    { q: "شي تاكله في الفطور", answers: [{text:"فول",pts:25},{text:"تميس",pts:20},{text:"بيض",pts:15},{text:"شاي",pts:10},{text:"جبن",pts:8}] },
    { q: "شي تستخدمه في المطبخ", answers: [{text:"قدر",pts:25},{text:"ملاعق",pts:20},{text:"فرن",pts:15},{text:"خلاط",pts:10},{text:"سكين",pts:8}] },
    { q: "شي تسويه في العيد", answers: [{text:"تلبس جديد",pts:25},{text:"توزع عيدية",pts:20},{text:"تزور الأهل",pts:15},{text:"تصور",pts:10},{text:"تأكل حلويات",pts:8}] },
    { q: "وسيلة مواصلات", answers: [{text:"سيارة",pts:30},{text:"دباب",pts:20},{text:"باص",pts:15},{text:"طيارة",pts:10},{text:"قطار",pts:8}] },
    { q: "شي تخليه في الثلاجة", answers: [{text:"ماء",pts:25},{text:"عصير",pts:20},{text:"حليب",pts:15},{text:"فاكهة",pts:10},{text:"بيض",pts:8}] },
    { q: "نشاط تسويه في البر", answers: [{text:"تشوي",pts:25},{text:"تفرش بساط",pts:20},{text:"تركب دباب",pts:15},{text:"تصيد",pts:10},{text:"تشرب شاي",pts:8}] },
    { q: "شي تشوفه في السماء", answers: [{text:"شمس",pts:25},{text:"قمر",pts:20},{text:"نجوم",pts:15},{text:"غيوم",pts:10},{text:"طيور",pts:8}] },
    { q: "حيوان أليف", answers: [{text:"قط",pts:25},{text:"كلب",pts:20},{text:"عصفور",pts:15},{text:"سمك",pts:10},{text:"أرنب",pts:8}] },
    { q: "شي تلاقيه في الشارع", answers: [{text:"سيارات",pts:25},{text:"إشارات مرور",pts:20},{text:"محلات",pts:15},{text:"أعمدة إنارة",pts:10},{text:"أشجار",pts:8}] },
    { q: "شي تشيله معك للسفر", answers: [{text:"شنطة",pts:25},{text:"جواز",pts:20},{text:"ملابس",pts:15},{text:"فلوس",pts:10},{text:"شاحن",pts:8}] },
    { q: "شي يبردك بالصيف", answers: [{text:"مكيف",pts:25},{text:"مروحة",pts:20},{text:"عصير بارد",pts:15},{text:"سباحة",pts:10},{text:"ثلج",pts:8}] },
    { q: "شي يخوف الأطفال", answers: [{text:"ظلام",pts:25},{text:"صراصير",pts:20},{text:"كلاب",pts:15},{text:"أصوات عالية",pts:10},{text:"أشباح",pts:8}] },
    { q: "شي موجود في الحديقة", answers: [{text:"أشجار",pts:25},{text:"زهور",pts:20},{text:"ألعاب",pts:15},{text:"مقاعد",pts:10},{text:"نافورة",pts:8}] },
    { q: "شي فيه أزرار", answers: [{text:"ريموت",pts:25},{text:"جوال",pts:20},{text:"كمبيوتر",pts:15},{text:"مصعد",pts:10},{text:"فرن",pts:8}] },
    { q: "شي له عجلات", answers: [{text:"سيارة",pts:25},{text:"دراجة",pts:20},{text:"كرسي متحرك",pts:15},{text:"عربة تسوق",pts:10},{text:"سكوتر",pts:8}] },
    { q: "شي تحتاجه وقت الطبخ", answers: [{text:"غاز",pts:25},{text:"زيت",pts:20},{text:"ملح",pts:15},{text:"خضار",pts:10},{text:"بهارات",pts:8}] },
    { q: "شي تشوفه في البحر", answers: [{text:"ماء",pts:25},{text:"أسماك",pts:20},{text:"قوارب",pts:15},{text:"أمواج",pts:10},{text:"شعب مرجانية",pts:8}] },
    { q: "شي له رائحة قوية", answers: [{text:"بصل",pts:25},{text:"ثوم",pts:20},{text:"عطر",pts:15},{text:"بنزين",pts:10},{text:"بخور",pts:8}] },
    { q: "مدينة سعودية", answers: [{text:"الرياض",pts:25},{text:"جدة",pts:20},{text:"مكة",pts:15},{text:"الدمام",pts:10},{text:"الطائف",pts:8}] }
  ];
}

/* -------------------------
  الأصوات MP3 (ضع الملفات في نفس المجلد)
   ------------------------- */
const correctSound = new Audio('correct.mp3');
const wrongSound = new Audio('wrong.mp3');
const applauseSound = new Audio('applause.mp3');
const bgMusic = new Audio('bg.mp3');
bgMusic.loop = true;
bgMusic.volume = 0.28;

// السماح بتشغيل الصوت بعد تفاعل المستخدم
document.addEventListener('click', ()=> {
  if (bgMusic.paused) {
    bgMusic.play().catch(()=>{/* بعض المتصفحات تمنع التشغيل التلقائي حتى تفاعل */});
  }
  // محاولة لتمكين الأصوات
  [correctSound, wrongSound, applauseSound].forEach(s => { try { s.volume = s.volume || 1 } catch(e){} });
});

function tryPlay(sound){
  sound.currentTime = 0;
  sound.play().catch(()=>{/* يتوقف عن اللعب إذا لم يُسمح */});
}

/* -------------------------
  عرض الجولة و الإجابات
   ------------------------- */
function startRound(index){
  current.index = index; current.revealed = []; current.strikes = 0; current.stealMode = false; current.stealBy = null; current.boardPoints = 0;
  const q = questions[index];
  qDisplay.textContent = q.q;
  qMeta.textContent = `عدد الإجابات: ${q.answers.length}`;
  renderAnswers();
  roundStateEl.textContent = `جاري اللعب - دور ${ team[currentAnsweringTeam].name }`;
  document.getElementById('stealSuccess').classList.add('hidden');
}

function renderAnswers(){
  answersGrid.innerHTML='';
  if(current.index===-1) return;
  const arr = questions[current.index].answers;
  arr.forEach((a,i)=>{
    const el = document.createElement('div'); el.className='answer';
    if(current.revealed.includes(i)) el.classList.add('revealed');
    el.innerHTML = `<div class="txt">${ current.revealed.includes(i) ? a.text : '—' }</div><div class="pts">${ current.revealed.includes(i) ? a.pts : '' }</div>`;
    el.addEventListener('click', ()=> toggleReveal(i));
    answersGrid.appendChild(el);
  })
}

function toggleReveal(i){
  if(current.index===-1) return;
  if(!current.revealed.includes(i)){
    current.revealed.push(i);
    tryPlay(correctSound);
    flashGreen();
    // لو كُشف كل الإجابات — تصفيق و كونفيتي
    if(current.revealed.length === questions[current.index].answers.length){
      tryPlay(applauseSound);
      throwConfetti();
    }
  } else {
    current.revealed = current.revealed.filter(x=>x!==i);
  }
  renderAnswers();
}

/* reveal next / flip all / clear */
document.getElementById('revealNext').addEventListener('click', ()=>{
  if(current.index===-1) return alert('اختر سؤالاً أولاً');
  const total = questions[current.index].answers.length;
  for(let i=0;i<total;i++){
    if(!current.revealed.includes(i)){ current.revealed.push(i); tryPlay(correctSound); break; }
  }
  if(current.revealed.length === questions[current.index].answers.length){ tryPlay(applauseSound); throwConfetti(); }
  renderAnswers();
});

document.getElementById('flipAll').addEventListener('click', ()=>{
  if(current.index===-1) return alert('اختر سؤالاً أولاً');
  current.revealed = questions[current.index].answers.map((_,i)=>i);
  renderAnswers();
  tryPlay(applauseSound);
  throwConfetti();
});

document.getElementById('clearReveal').addEventListener('click', ()=>{
  current.revealed = []; renderAnswers(); roundStateEl.textContent='جاهز';
});

/* previous reveal */
document.getElementById('prevReveal').addEventListener('click', ()=>{
  if(current.revealed.length===0) return;
  current.revealed.pop(); renderAnswers();
});

/* -------------------------
  نقاط و أخطاء + سترايك / جولة السرقة
   ------------------------- */
function updateScores(){ document.getElementById('teamAScore').textContent = team.A.score; document.getElementById('teamBScore').textContent = team.B.score }

document.getElementById('awardA').addEventListener('click', ()=>{
  if(current.index===-1) return alert('لا جولة');
  // إذا نحن في جولة سرقة والجهة السارقة هي A -> نعتبرها نجاح سرقة
  if(current.stealMode && current.stealBy === 'A'){
    // نجاح السرقة للفريق A
    tryPlay(correctSound); flashGreen();
    team.A.score += current.boardPoints;
    updateScores();
    alert(`${team.A.name} نجح في السرقة وحصل على ${current.boardPoints} نقطة`);
    current.stealMode = false;
    roundStateEl.textContent = 'انتهت الجولة';
    document.getElementById('stealSuccess').classList.add('hidden');
    return;
  }
  // العادة: نمنح نقاط الإجابات المكشوفة
  const pts = current.revealed.reduce((s,i)=> s + (questions[current.index].answers[i].pts||0),0);
  team.A.score += pts; updateScores();
  tryPlay(applauseSound); throwConfetti();
  alert(`أعطيت ${pts} نقطة لـ ${team.A.name}`);
});

document.getElementById('awardB').addEventListener('click', ()=>{
  if(current.index===-1) return alert('لا جولة');
  // إذا نحن في جولة سرقة والجهة السارقة هي B -> نعتبرها نجاح سرقة
  if(current.stealMode && current.stealBy === 'B'){
    tryPlay(correctSound); flashGreen();
    team.B.score += current.boardPoints;
    updateScores();
    alert(`${team.B.name} نجح في السرقة وحصل على ${current.boardPoints} نقطة`);
    current.stealMode = false;
    roundStateEl.textContent = 'انتهت الجولة';
    document.getElementById('stealSuccess').classList.add('hidden');
    return;
  }
  const pts = current.revealed.reduce((s,i)=> s + (questions[current.index].answers[i].pts||0),0);
  team.B.score += pts; updateScores();
  tryPlay(applauseSound); throwConfetti();
  alert(`أعطيت ${pts} نقطة لـ ${team.B.name}`);
});

document.getElementById('strike').addEventListener('click', ()=>{
  if(current.index===-1) return alert('لا جولة');
  // إذا في جولة سرقة حاليا => هذه ضربة للفريق السارِق (فشل السرقة)
  if(current.stealMode){
    tryPlay(wrongSound);
    // الفشل: نقاط اللوح تذهب للفريق الأصلي (الذي أخذ 3 سترايك)
    const original = (current.stealBy === 'A') ? 'B' : 'A'; // مَن ارتكب 3 سترايك هو الآخر
    team[original].score += current.boardPoints;
    updateScores();
    alert(`${team[current.stealBy].name} أخفق في السرقة. ${team[original].name} يحتفظ بـ ${current.boardPoints} نقطة`);
    current.stealMode = false;
    current.stealBy = null;
    current.boardPoints = 0;
    roundStateEl.textContent = 'انتهت الجولة';
    document.getElementById('stealSuccess').classList.add('hidden');
    return;
  }

  // زيادة سترايك للفريق الذي يجيب الآن
  current.strikes = (current.strikes || 0) + 1;
  tryPlay(wrongSound);
  roundStateEl.textContent = `أخطاء: ${current.strikes} — دور ${team[currentAnsweringTeam].name}`;
  if(current.strikes >= 3){
    // تفعيل جولة السرقة: الفريق الآخر يحصل على فرصة السرقة
    const other = (currentAnsweringTeam === 'A') ? 'B' : 'A';
    current.stealMode = true;
    current.stealBy = other;
    // نقاط اللوح = مجموع نقاط كل الإجابات على اللوح
    current.boardPoints = questions[current.index].answers.reduce((s,a)=> s + (a.pts||0), 0);
    roundStateEl.textContent = `جولة السرقة - دور ${team[other].name}`;
    alert(`3 سترايك! الآن دور ${team[other].name} في جولة السرقة (القيمة: ${current.boardPoints} نقطة).`);
    document.getElementById('stealSuccess').classList.remove('hidden');
  }
});

/* زر نجاح السرقة (يكفي للمضيف يضغطه لو الفريق السارق جاوب صح) */
document.getElementById('stealSuccess').addEventListener('click', ()=>{
  if(!current.stealMode) return;
  const winner = current.stealBy;
  tryPlay(correctSound); flashGreen();
  team[winner].score += current.boardPoints;
  updateScores();
  alert(`${team[winner].name} نجحوا في السرقة وحصلوا على ${current.boardPoints} نقطة`);
  current.stealMode = false;
  current.stealBy = null;
  current.boardPoints = 0;
  roundStateEl.textContent = 'انتهت الجولة';
  document.getElementById('stealSuccess').classList.add('hidden');
});

/* -------------------------
  أزرار مساعدة: جولة جديدة و إعادة نقاط
   ------------------------- */
document.getElementById('newRound').addEventListener('click', ()=>{
  current.index=-1; current.revealed=[]; current.strikes=0; current.stealMode=false; current.stealBy=null; current.boardPoints=0;
  qDisplay.textContent='اضغط على سؤال من الجهة اليسرى لبدء الجولة'; qMeta.textContent='—'; answersGrid.innerHTML=''; roundStateEl.textContent='جاهز';
  document.getElementById('stealSuccess').classList.add('hidden');
});

document.getElementById('resetScores').addEventListener('click', ()=>{ if(confirm('إعادة النقاط؟')){team.A.score=0;team.B.score=0;updateScores()} });

/* تحميل عينات عند التشغيل */
questions = sampleQuestions(); renderQuestions(); updateScores();

/* -------------------------
  فلاش أخضر
   ------------------------- */
function flashGreen(){
  document.body.classList.add('flash-green');
  setTimeout(()=>document.body.classList.remove('flash-green'), 350);
}

/* -------------------------
  Confetti (كانفاس بسيط)
   ------------------------- */
const confCanvas = document.getElementById('confetti');
const ctx = confCanvas.getContext('2d');
let confettiPieces = [];
function resizeCanvas(){ confCanvas.width = window.innerWidth; confCanvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();
function throwConfetti(){
  const count = 90;
  for(let i=0;i<count;i++) confettiPieces.push(createPiece());
  if(!animating){ animating=true; requestAnimationFrame(drawConfetti); }
}
function createPiece(){
  const w = Math.random()*10 + 6;
  const h = Math.random()*6 + 4;
  return {
    x: Math.random()*confCanvas.width,
    y: -20 - Math.random()*confCanvas.height*0.1,
    vx: (Math.random()-0.5)*4,
    vy: Math.random()*3 + 2,
    rot: Math.random()*360,
    dang: (Math.random()-0.5)*0.2,
    w, h,
    color: `hsl(${Math.floor(Math.random()*360)}, 70%, 60%)`,
    life: 0
  }
}
let animating = false;
function drawConfetti(){
  ctx.clearRect(0,0,confCanvas.width, confCanvas.height);
  for(let i=confettiPieces.length-1;i>=0;i--){
    const p = confettiPieces[i];
    p.x += p.vx; p.y += p.vy; p.vy += 0.06; p.rot += p.dang * 10; p.life++;
    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot * Math.PI / 180);
    ctx.fillStyle = p.color; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
    ctx.restore();
    if(p.y > confCanvas.height + 50 || p.life > 400) confettiPieces.splice(i,1);
  }
  if(confettiPieces.length>0) requestAnimationFrame(drawConfetti); else animating=false;
}

/* -------------------------
  حفظ / تحميل JSON لأسئلة
   ------------------------- */
function exportJSON(){
  const data = JSON.stringify(questions, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='mkhawir_questions.json';
  a.click(); URL.revokeObjectURL(url);
}
document.getElementById('exportBtn').addEventListener('click', exportJSON);

document.getElementById('importFile').addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const parsed = JSON.parse(ev.target.result);
      if(Array.isArray(parsed)) { questions = parsed; renderQuestions(); alert('تم استيراد الأسئلة'); }
      else alert('الملف غير صحيح');
    } catch(err){ alert('خطأ في قراءة الملف'); }
  };
  reader.readAsText(file);
});

</script>
</body>
</html>
